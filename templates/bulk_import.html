{% extends "base.html" %}

{% block title %}
    {% if vulnerable %}SQL Injection Demo{% else %}Secure Bulk Import{% endif %} - RMIT NeoBank
{% endblock %}

{% block content %}
<!-- Breadcrumb -->
<nav aria-label="breadcrumb" class="mb-3">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{{ url_for('dashboard') }}">Dashboard</a></li>
        <li class="breadcrumb-item active">
            {% if vulnerable %}Vulnerable Bulk Import{% else %}Secure Bulk Import{% endif %}
        </li>
    </ol>
</nav>

{% if vulnerable %}
<!-- ========================================================================= -->
<!-- VULNERABLE IMPLEMENTATION (Command Injection Demo)                        -->
<!-- ========================================================================= -->

<div class="card border-primary">
    <div class="card-header bg-primary text-white">
        <h4 class="mb-0">
            <i class="bi bi-cloud-upload-fill"></i> Bulk Import Applications
        </h4>
    </div>
    <div class="card-body">
        <form method="post">
            <div class="row g-3">
                <div class="col-md-8">
                    <label for="filename" class="form-label">
                        <i class="bi bi-file-earmark"></i> Filename (on server)
                    </label>
                    <input type="text" class="form-control form-control-lg" id="filename" name="filename" 
                           placeholder="e.g., data.csv" required>
                    <small class="text-muted">
                        Enter the filename of the CSV file to import
                    </small>
                </div>
                <div class="col-md-4 d-flex align-items-end">
                    <button type="submit" class="btn btn-primary btn-lg w-100">
                        <i class="bi bi-upload"></i> Import Data
                    </button>
                </div>
            </div>
        </form>
        
        {% if command_executed %}
        <div class="alert alert-info mt-3" role="alert">
            <h6><i class="bi bi-terminal"></i> Import Command:</h6>
            <pre class="bg-dark text-light p-3 rounded mb-0"><strong>$ {{ command_executed }}</strong></pre>
        </div>
        {% endif %}
    </div>
</div>

{% else %}
<!-- ========================================================================= -->
<!-- SECURE IMPLEMENTATION (File Upload with CSV Parsing)                      -->
<!-- ========================================================================= -->

<div class="alert alert-success shadow-lg" role="alert">
    <h4 class="alert-heading">
        <i class="bi bi-shield-check-fill"></i> âœ… SECURE IMPLEMENTATION
    </h4>
    <p><strong>This implementation follows security best practices.</strong></p>
    <hr>
    <h6>Security Controls:</h6>
    <ul class="mb-0">
        <li><strong>File Upload:</strong> Uses Flask's <code>request.files</code> (no shell commands)</li>
        <li><strong>CSV Parsing:</strong> Python's <code>csv</code> module (no external executables)</li>
        <li><strong>File Type Validation:</strong> Only .csv files accepted</li>
        <li><strong>Safe Filename:</strong> Generated server-side (prevents path traversal)</li>
        <li><strong>Input Validation:</strong> Each row validated before database insertion</li>
        <li><strong>RBAC:</strong> Only HO officers can use this feature</li>
    </ul>
</div>

<div class="card border-success">
    <div class="card-header bg-success text-white">
        <h4 class="mb-0">
            <i class="bi bi-shield-check"></i> Secure Bulk Import (File Upload)
        </h4>
    </div>
    <div class="card-body">
        <form method="post" enctype="multipart/form-data">
            <div class="row g-3">
                <div class="col-md-8">
                    <label for="csv_file" class="form-label">
                        <i class="bi bi-file-earmark-arrow-up"></i> Upload CSV File
                    </label>
                    <input type="file" class="form-control form-control-lg" id="csv_file" name="csv_file" 
                           accept=".csv" required>
                    <small class="text-muted">
                        <strong>Required columns:</strong> applicant_name, national_id, dob, contact_phone, 
                        contact_email, product_code, requested_amount, tenure_months
                    </small>
                </div>
                <div class="col-md-4 d-flex align-items-end">
                    <button type="submit" class="btn btn-success btn-lg w-100">
                        <i class="bi bi-upload"></i> Upload & Import (Secure)
                    </button>
                </div>
            </div>
        </form>
        
        {% if imported_count %}
        <div class="alert alert-success mt-3" role="alert">
            <h5 class="alert-heading">
                <i class="bi bi-check-circle-fill"></i> Import Successful
            </h5>
            <p class="mb-0">
                <strong>{{ imported_count }}</strong> applications imported successfully.
                {% if error_count %}
                <br><span class="text-warning">{{ error_count }} rows failed validation and were skipped.</span>
                {% endif %}
            </p>
        </div>
        {% endif %}
        
        <!-- CSV Template Download -->
        <div class="mt-4">
            <h6><i class="bi bi-file-earmark-spreadsheet"></i> CSV Template Example:</h6>
            <div class="card bg-light">
                <div class="card-body">
                    <pre class="mb-0" style="font-size: 0.85rem;">application_ref,applicant_name,national_id,dob,contact_phone,contact_email,product_code,requested_amount,tenure_months,branch_code,remarks
APP-001,Nguyen Van An,001234567890,1990-05-15,+84901234567,nguyen.van.an@example.com,PL_SAL,50000000,36,HCM01,First time customer
APP-002,Tran Thi Binh,009876543210,1985-08-22,+84909876543,tran.thi.binh@example.com,HL_STD,200000000,240,HN01,Home loan for new property</pre>
                </div>
            </div>
            <small class="text-muted">
                ðŸ’¡ Copy this template to create your CSV file. Save as UTF-8 encoding.
            </small>
        </div>
    </div>
</div>

{% endif %}

<!-- Back Button -->
<div class="mt-4">
    <a href="{{ url_for('dashboard') }}" class="btn btn-secondary">
        <i class="bi bi-arrow-left"></i> Back to Dashboard
    </a>
</div>

{% endblock %}
